# Excalidraw æŠ€æœ¯å®ç°å®Œæ•´æ•™ç¨‹ - è¯¾ç¨‹æ€»ç»“

## è¯¾ç¨‹æ¦‚è§ˆ

æœ¬ç³»åˆ—æ•™ç¨‹æ·±å…¥è®²è§£äº† Excalidraw è¿™ä¸€ä¼˜ç§€çš„å¼€æºç»˜å›¾å·¥å…·çš„æŠ€æœ¯å®ç°åŸç†ï¼Œä»é›¶å¼€å§‹æ„å»ºä¸€ä¸ªå®Œæ•´çš„åœ¨çº¿ç»˜å›¾åº”ç”¨ã€‚è¯¾ç¨‹åˆ†ä¸º10ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½åŒ…å«è¯¦ç»†çš„ç†è®ºè®²è§£ã€ä»£ç å®ç°å’Œå®è·µé¡¹ç›®ã€‚

## ç« èŠ‚å†…å®¹å›é¡¾

### ç¬¬ä¸€ç« ï¼šCanvasåŸºç¡€ä¸Webå›¾å½¢å­¦ ğŸ“š
**æ ¸å¿ƒæ¦‚å¿µï¼š** Canvas 2D APIã€é«˜DPIé€‚é…ã€åæ ‡ç³»ç»Ÿ
**ä¸»è¦å®ç°ï¼š**
- å®Œæ•´çš„ç»˜å›¾æ¿åº”ç”¨
- å¤šå·¥å…·æ”¯æŒï¼ˆç”»ç¬”ã€çŸ©å½¢ã€åœ†å½¢ã€æ©¡çš®æ“¦ï¼‰
- é«˜DPIå±å¹•é€‚é…
- æ€§èƒ½ä¼˜åŒ–çš„æ¸²æŸ“å¾ªç¯

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// é«˜DPIé€‚é…
const dpr = window.devicePixelRatio || 1;
canvas.width = canvasWidth * dpr;
canvas.height = canvasHeight * dpr;
canvas.style.width = canvasWidth + 'px';
canvas.style.height = canvasHeight + 'px';
ctx.scale(dpr, dpr);
```

### ç¬¬äºŒç« ï¼šæ•°å­¦å‡ ä½•åŸºç¡€ä¸ç®—æ³• ğŸ”¢
**æ ¸å¿ƒæ¦‚å¿µï¼š** å‘é‡è¿ç®—ã€å˜æ¢çŸ©é˜µã€ç¢°æ’æ£€æµ‹
**ä¸»è¦å®ç°ï¼š**
- Vector2 å’Œ Transform2D ç±»
- SATã€AABB ç¢°æ’æ£€æµ‹ç®—æ³•
- å°„çº¿æŠ•å°„ç®—æ³•
- å‡ ä½•è®¡ç®—å™¨åº”ç”¨

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// å‘é‡ç‚¹ç§¯è®¡ç®—
dot(other: Vector2): number {
  return this.x * other.x + this.y * other.y;
}

// 2Då˜æ¢çŸ©é˜µ
transform(point: Vector2): Vector2 {
  return new Vector2(
    this.a * point.x + this.c * point.y + this.e,
    this.b * point.x + this.d * point.y + this.f
  );
}
```

### ç¬¬ä¸‰ç« ï¼šäº‹ä»¶äº¤äº’ä¸ç”¨æˆ·è¾“å…¥ ğŸ‘†
**æ ¸å¿ƒæ¦‚å¿µï¼š** Pointer Eventsã€æ‰‹åŠ¿è¯†åˆ«ã€é”®ç›˜å¿«æ·é”®
**ä¸»è¦å®ç°ï¼š**
- ç»Ÿä¸€çš„æŒ‡é’ˆäº‹ä»¶å¤„ç†ç³»ç»Ÿ
- æ‰‹åŠ¿è¯†åˆ«å™¨ï¼ˆå¹³ç§»ã€ç¼©æ”¾ã€æ—‹è½¬ï¼‰
- ä¸Šä¸‹æ–‡ç›¸å…³çš„å¿«æ·é”®ç³»ç»Ÿ
- å¤šç‚¹è§¦æ§æ”¯æŒ

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// æ‰‹åŠ¿è¯†åˆ«
class GestureRecognizer {
  recognizePinch(pointers: PointerState[]): PinchGesture | null {
    if (pointers.length !== 2) return null;
    
    const distance = this.calculateDistance(pointers[0], pointers[1]);
    const center = this.calculateCenter(pointers);
    
    return { distance, center, scale: distance / this.initialDistance };
  }
}
```

### ç¬¬å››ç« ï¼šçŠ¶æ€ç®¡ç†ä¸æ•°æ®æµ ğŸ”„
**æ ¸å¿ƒæ¦‚å¿µï¼š** Jotai åŸå­çŠ¶æ€ã€ä¸å¯å˜æ›´æ–°ã€å†å²ç®¡ç†
**ä¸»è¦å®ç°ï¼š**
- åŸå­åŒ–çŠ¶æ€ç®¡ç†ç³»ç»Ÿ
- æ’¤é”€/é‡åšåŠŸèƒ½
- çŠ¶æ€ç¼“å­˜å’Œä¼˜åŒ–
- å“åº”å¼æ•°æ®æµ

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// Jotai åŸå­çŠ¶æ€
const elementsAtom = atom<ExcalidrawElement[]>([]);
const selectedElementsAtom = atom(
  (get) => get(elementsAtom).filter(el => el.isSelected),
  (get, set, selectedIds: string[]) => {
    const elements = get(elementsAtom);
    set(elementsAtom, elements.map(el => ({
      ...el,
      isSelected: selectedIds.includes(el.id)
    })));
  }
);
```

### ç¬¬äº”ç« ï¼šå…ƒç´ ç³»ç»Ÿä¸å›¾å½¢æŠ½è±¡ ğŸ“
**æ ¸å¿ƒæ¦‚å¿µï¼š** æŠ½è±¡å…ƒç´ ç±»ã€å·¥å‚æ¨¡å¼ã€åºåˆ—åŒ–
**ä¸»è¦å®ç°ï¼š**
- BaseElement æŠ½è±¡ç±»æ¶æ„
- å…·ä½“å…ƒç´ ç±»å‹ï¼ˆçŸ©å½¢ã€æ¤­åœ†ã€çº¿æ¡ã€æ–‡æœ¬ã€å›¾ç‰‡ï¼‰
- å…ƒç´ å·¥å‚å’Œç®¡ç†å™¨
- ç¾¤ç»„ç®¡ç†ç³»ç»Ÿ

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// å…ƒç´ åŸºç±»
abstract class BaseElement {
  abstract render(ctx: CanvasRenderingContext2D): void;
  abstract getBounds(): DirtyRect;
  abstract containsPoint(point: Vector2): boolean;
  abstract serialize(): any;
}

// å·¥å‚æ¨¡å¼
class ElementFactory {
  static createElement(type: string, data: any): BaseElement {
    switch (type) {
      case 'rectangle': return new RectangleElement(data);
      case 'ellipse': return new EllipseElement(data);
      default: throw new Error(`Unknown element type: ${type}`);
    }
  }
}
```

### ç¬¬å…­ç« ï¼šæ¸²æŸ“å¼•æ“ä¸å¯è§†åŒ– ğŸ¨
**æ ¸å¿ƒæ¦‚å¿µï¼š** åˆ†å±‚æ¸²æŸ“ã€è§†å£ç®¡ç†ã€åŠ¨ç”»ç³»ç»Ÿ
**ä¸»è¦å®ç°ï¼š**
- å¤šå±‚æ¸²æŸ“æ¶æ„
- è§†å£å˜æ¢å’ŒåŠ¨ç”»
- è„çŸ©å½¢ä¼˜åŒ–
- æ‰¹é‡æ¸²æŸ“ç³»ç»Ÿ

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// åˆ†å±‚æ¸²æŸ“å™¨
class LayeredRenderer {
  private layers = new Map<string, RenderLayer>();
  
  renderLayer(layerName: string, elements: ExcalidrawElement[]): void {
    const layer = this.layers.get(layerName);
    if (!layer) return;
    
    layer.ctx.clearRect(0, 0, layer.canvas.width, layer.canvas.height);
    elements.forEach(element => element.render(layer.ctx));
  }
}
```

### ç¬¬ä¸ƒç« ï¼šå·¥å…·ç³»ç»Ÿä¸ç»˜å›¾å·¥å…· ğŸ› ï¸
**æ ¸å¿ƒæ¦‚å¿µï¼š** å·¥å…·æŠ½è±¡ã€çŠ¶æ€æœºã€å·¥å…·ç®¡ç†å™¨
**ä¸»è¦å®ç°ï¼š**
- BaseTool æŠ½è±¡å·¥å…·ç±»
- å…·ä½“ç»˜å›¾å·¥å…·ï¼ˆé€‰æ‹©ã€çŸ©å½¢ã€æ¤­åœ†ã€çº¿æ¡ã€ç®­å¤´ï¼‰
- å·¥å…·ç®¡ç†å™¨å’Œåˆ‡æ¢ç³»ç»Ÿ
- å·¥å…·é€‰é¡¹å’Œé…ç½®

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// å·¥å…·åŸºç±»
abstract class BaseTool {
  abstract onPointerDown(event: PointerEvent, state: AppState): AppState;
  abstract onPointerMove(event: PointerEvent, state: AppState): AppState;
  abstract onPointerUp(event: PointerEvent, state: AppState): AppState;
}

// å·¥å…·ç®¡ç†å™¨
class ToolManager {
  private tools = new Map<string, BaseTool>();
  private activeTool: BaseTool | null = null;
  
  setActiveTool(toolName: string): void {
    this.activeTool = this.tools.get(toolName) || null;
  }
}
```

### ç¬¬å…«ç« ï¼šæ‰‹ç»˜é£æ ¼ä¸è§†è§‰æ•ˆæœ âœï¸
**æ ¸å¿ƒæ¦‚å¿µï¼š** RoughJS é›†æˆã€å™ªå£°ç®—æ³•ã€çº¹ç†ç”Ÿæˆ
**ä¸»è¦å®ç°ï¼š**
- æ‰‹ç»˜é£æ ¼åˆ†æå’Œå‚æ•°ç”Ÿæˆ
- å¤šç§å™ªå£°ç®—æ³•ï¼ˆPerlinã€FBMã€Cellularï¼‰
- RoughJS è‡ªå®šä¹‰ç”Ÿæˆå™¨
- é˜´å½±å’Œå…‰ç…§ç³»ç»Ÿ

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// Perlin å™ªå£°ç”Ÿæˆå™¨
class PerlinNoise {
  noise(x: number, y: number): number {
    const xi = Math.floor(x) & 255;
    const yi = Math.floor(y) & 255;
    
    const xf = x - Math.floor(x);
    const yf = y - Math.floor(y);
    
    const u = this.fade(xf);
    const v = this.fade(yf);
    
    return this.lerp(v,
      this.lerp(u, this.grad(this.p[xi + this.p[yi]], xf, yf),
                   this.grad(this.p[xi + 1 + this.p[yi]], xf - 1, yf)),
      this.lerp(u, this.grad(this.p[xi + this.p[yi + 1]], xf, yf - 1),
                   this.grad(this.p[xi + 1 + this.p[yi + 1]], xf - 1, yf - 1))
    );
  }
}
```

### ç¬¬ä¹ç« ï¼šåä½œç³»ç»Ÿä¸å®æ—¶é€šä¿¡ ğŸ¤
**æ ¸å¿ƒæ¦‚å¿µï¼š** æ“ä½œè½¬æ¢ã€WebSocketé€šä¿¡ã€å†²çªè§£å†³
**ä¸»è¦å®ç°ï¼š**
- å®æ—¶åä½œæ¶æ„
- æ“ä½œè½¬æ¢ç®—æ³•ï¼ˆOTï¼‰
- å‘é‡æ—¶é’ŸåŒæ­¥
- ç”¨æˆ·çŠ¶æ€ç®¡ç†

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// æ“ä½œè½¬æ¢
class OperationTransformer {
  transform(op1: Operation, op2: Operation): TransformResult {
    if (!op1.vectorClock.isConcurrent(op2.vectorClock)) {
      return { transformedOp1: op1, transformedOp2: op2 };
    }
    return this.transformByType(op1, op2);
  }
}

// WebSocket é€šä¿¡
class WebSocketTransport {
  sendOperation(operation: Operation): void {
    const message = { type: 'operation', data: operation };
    this.ws.send(JSON.stringify(message));
  }
}
```

### ç¬¬åç« ï¼šæ€§èƒ½ä¼˜åŒ–ä¸è™šæ‹ŸåŒ– âš¡
**æ ¸å¿ƒæ¦‚å¿µï¼š** æ€§èƒ½ç›‘æ§ã€å†…å­˜ç®¡ç†ã€è§†å£ä¼˜åŒ–
**ä¸»è¦å®ç°ï¼š**
- æ€§èƒ½ç›‘æ§ç³»ç»Ÿ
- è„çŸ©å½¢æ›´æ–°
- å¯¹è±¡æ± æ¨¡å¼
- è™šæ‹ŸåŒ–æ¸²æŸ“

**å…³é”®æŠ€æœ¯ç‚¹ï¼š**
```typescript
// å¯¹è±¡æ± 
class ObjectPool<T> {
  private pool: T[] = [];
  
  acquire(): T {
    return this.pool.pop() || this.createFn();
  }
  
  release(obj: T): void {
    this.resetFn(obj);
    this.pool.push(obj);
  }
}

// å››å‰æ ‘ç©ºé—´ç´¢å¼•
class QuadTree {
  queryRange(range: DirtyRect): ExcalidrawElement[] {
    const result: ExcalidrawElement[] = [];
    this.queryNode(this.root, range, result);
    return result;
  }
}
```

## æŠ€æœ¯æ ˆæ€»ç»“

### æ ¸å¿ƒæŠ€æœ¯
- **Canvas 2D API**: åº•å±‚ç»˜å›¾æ¥å£
- **TypeScript**: ç±»å‹å®‰å…¨çš„JavaScriptè¶…é›†
- **React**: ç”¨æˆ·ç•Œé¢æ„å»º
- **Jotai**: åŸå­åŒ–çŠ¶æ€ç®¡ç†

### æ•°å­¦ä¸ç®—æ³•
- **çº¿æ€§ä»£æ•°**: å‘é‡ã€çŸ©é˜µè¿ç®—
- **è®¡ç®—å‡ ä½•**: ç¢°æ’æ£€æµ‹ã€ç©ºé—´ç´¢å¼•
- **å™ªå£°ç®—æ³•**: Perlinã€FBMã€Cellular
- **æ“ä½œè½¬æ¢**: åä½œç¼–è¾‘å†²çªè§£å†³

### æ€§èƒ½ä¼˜åŒ–
- **è„çŸ©å½¢æ›´æ–°**: æœ€å°åŒ–é‡ç»˜åŒºåŸŸ
- **åˆ†å±‚æ¸²æŸ“**: åˆ†ç¦»ä¸åŒç±»å‹å†…å®¹
- **å¯¹è±¡æ± **: å‡å°‘åƒåœ¾å›æ”¶å‹åŠ›
- **è™šæ‹ŸåŒ–**: åªæ¸²æŸ“å¯è§å†…å®¹

### åä½œæŠ€æœ¯
- **WebSocket**: å®æ—¶åŒå‘é€šä¿¡
- **å‘é‡æ—¶é’Ÿ**: åˆ†å¸ƒå¼æ—¶é—´åŒæ­¥
- **CRDT**: æ— å†²çªæ•°æ®ç»“æ„

## é¡¹ç›®äº®ç‚¹

### 1. å®Œæ•´çš„æ¶æ„è®¾è®¡
- æ¸…æ™°çš„æ¨¡å—åˆ†ç¦»
- å¯æ‰©å±•çš„æ’ä»¶ç³»ç»Ÿ
- ç±»å‹å®‰å…¨çš„æ¥å£è®¾è®¡

### 2. é«˜æ€§èƒ½æ¸²æŸ“
- æ™ºèƒ½çš„è„çŸ©å½¢ç®¡ç†
- åˆ†å±‚æ¸²æŸ“ä¼˜åŒ–
- GPUåŠ é€Ÿæ”¯æŒ

### 3. ä¸°å¯Œçš„äº¤äº’ä½“éªŒ
- å¤šç‚¹è§¦æ§æ”¯æŒ
- æ‰‹åŠ¿è¯†åˆ«
- é”®ç›˜å¿«æ·é”®

### 4. å®æ—¶åä½œèƒ½åŠ›
- æ¯«ç§’çº§åŒæ­¥
- æ™ºèƒ½å†²çªè§£å†³
- ç”¨æˆ·æ„ŸçŸ¥ç•Œé¢

### 5. æ‰‹ç»˜ç¾å­¦
- è‡ªç„¶çš„æ‰‹ç»˜æ•ˆæœ
- ä¸°å¯Œçš„è§†è§‰æ ·å¼
- è‡ªå®šä¹‰çº¹ç†æ”¯æŒ

## å­¦ä¹ è·¯å¾„å»ºè®®

### åˆå­¦è€…è·¯å¾„
1. **CanvasåŸºç¡€** â†’ æŒæ¡åŸºæœ¬ç»˜å›¾API
2. **æ•°å­¦åŸºç¡€** â†’ ç†è§£å‘é‡å’Œå˜æ¢
3. **äº‹ä»¶å¤„ç†** â†’ å­¦ä¹ ç”¨æˆ·äº¤äº’
4. **å…ƒç´ ç³»ç»Ÿ** â†’ æ„å»ºå›¾å½¢æŠ½è±¡

### è¿›é˜¶è·¯å¾„
5. **æ¸²æŸ“å¼•æ“** â†’ ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½
6. **å·¥å…·ç³»ç»Ÿ** â†’ å®ç°ç»˜å›¾å·¥å…·
7. **çŠ¶æ€ç®¡ç†** â†’ å¤„ç†å¤æ‚çŠ¶æ€

### é«˜çº§è·¯å¾„
8. **æ‰‹ç»˜é£æ ¼** â†’ æ·»åŠ è§†è§‰æ•ˆæœ
9. **åä½œç³»ç»Ÿ** â†’ å®ç°å®æ—¶åä½œ
10. **æ€§èƒ½ä¼˜åŒ–** â†’ å¤„ç†å¤§è§„æ¨¡æ•°æ®

## å®é™…åº”ç”¨

### å¯ä»¥åŸºäºæ­¤æ•™ç¨‹æ„å»ºçš„åº”ç”¨
- **åœ¨çº¿ç™½æ¿**: å›¢é˜Ÿåä½œç»˜å›¾
- **æ€ç»´å¯¼å›¾**: çŸ¥è¯†ç»“æ„å¯è§†åŒ–
- **æµç¨‹å›¾ç¼–è¾‘å™¨**: ä¸šåŠ¡æµç¨‹è®¾è®¡
- **åŸå‹è®¾è®¡å·¥å…·**: UI/UXè®¾è®¡
- **æ•°æ®å¯è§†åŒ–**: å›¾è¡¨å’Œå›¾å½¢å±•ç¤º

### æŠ€æœ¯æ‰©å±•æ–¹å‘
- **3Då›¾å½¢**: Three.jsé›†æˆ
- **AIè¾…åŠ©**: æ™ºèƒ½å›¾å½¢è¯†åˆ«
- **ç§»åŠ¨ç«¯**: è§¦å±ä¼˜åŒ–
- **ç¦»çº¿æ”¯æŒ**: PWAæŠ€æœ¯
- **æ’ä»¶ç”Ÿæ€**: ç¬¬ä¸‰æ–¹æ‰©å±•

## åç»­å­¦ä¹ èµ„æº

### ç›¸å…³æŠ€æœ¯æ·±å…¥
- **WebGL**: ç¡¬ä»¶åŠ é€Ÿå›¾å½¢
- **WebAssembly**: é«˜æ€§èƒ½è®¡ç®—
- **Web Workers**: å¤šçº¿ç¨‹å¤„ç†
- **WebRTC**: P2Påä½œ

### å¼€æºé¡¹ç›®å‚è€ƒ
- **Excalidraw**: æœ¬æ•™ç¨‹çš„çµæ„Ÿæ¥æº
- **Fabric.js**: Canvaså¯¹è±¡æ¨¡å‹
- **Paper.js**: å‘é‡å›¾å½¢æ¡†æ¶
- **Konva.js**: 2Dç”»å¸ƒåº“

### è®¾è®¡æ¨¡å¼åº”ç”¨
- **MVC/MVVM**: æ¶æ„æ¨¡å¼
- **è§‚å¯Ÿè€…æ¨¡å¼**: äº‹ä»¶ç³»ç»Ÿ
- **å·¥å‚æ¨¡å¼**: å…ƒç´ åˆ›å»º
- **ç­–ç•¥æ¨¡å¼**: å·¥å…·åˆ‡æ¢

## è¯¾ç¨‹æˆæœ

é€šè¿‡å®Œæˆæœ¬ç³»åˆ—æ•™ç¨‹ï¼Œæ‚¨å°†ï¼š

âœ… **æŒæ¡Canvaså›¾å½¢ç¼–ç¨‹** - ä»åŸºç¡€APIåˆ°é«˜çº§æŠ€å·§
âœ… **ç†è§£ç°ä»£å‰ç«¯æ¶æ„** - ç»„ä»¶åŒ–ã€çŠ¶æ€ç®¡ç†ã€æ€§èƒ½ä¼˜åŒ–
âœ… **å­¦ä¼šåä½œç³»ç»Ÿè®¾è®¡** - å®æ—¶åŒæ­¥ã€å†²çªè§£å†³
âœ… **å…·å¤‡æ€§èƒ½è°ƒä¼˜èƒ½åŠ›** - ç›‘æ§ã€åˆ†æã€ä¼˜åŒ–
âœ… **æ‹¥æœ‰å®Œæ•´é¡¹ç›®ç»éªŒ** - ä»é›¶åˆ°ä¸€æ„å»ºå¤æ‚åº”ç”¨

è¿™ä¸ä»…æ˜¯ä¸€ä¸ªæŠ€æœ¯æ•™ç¨‹ï¼Œæ›´æ˜¯ä¸€æ¬¡å®Œæ•´çš„è½¯ä»¶å·¥ç¨‹å®è·µã€‚å¸Œæœ›è¿™ä¸ªç³»åˆ—èƒ½å¤Ÿå¸®åŠ©æ‚¨æ·±å…¥ç†è§£ç°ä»£Webå›¾å½¢åº”ç”¨çš„å¼€å‘ï¼Œå¹¶ä¸ºæ‚¨çš„æŠ€æœ¯æˆé•¿æä¾›æœ‰ä»·å€¼çš„å‚è€ƒã€‚

---

**æ„Ÿè°¢æ‚¨çš„å­¦ä¹ ï¼** ğŸ‰

å¦‚æœæ‚¨åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿å‚è€ƒæºç å®ç°æˆ–è€…æŸ¥é˜…ç›¸å…³æŠ€æœ¯æ–‡æ¡£ã€‚ç»§ç»­æ¢ç´¢ï¼Œä¸æ–­åˆ›æ–°ï¼